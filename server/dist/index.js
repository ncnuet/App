(()=>{"use strict";var e={4742:(e,t)=>{function n(){return Object.assign({},t.cookieSecureOption)}Object.defineProperty(t,"__esModule",{value:!0}),t.withSession=t.withAge=t.cookieSecureOption=void 0,t.cookieSecureOption={httpOnly:!0,secure:!0},t.withAge=function(e){return void 0===e?n():Object.assign(Object.assign({},t.cookieSecureOption),{maxAge:e})},t.withSession=n},2009:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.connect=void 0;const i=o(n(1185)),s=o(n(5343)),{MG_HOST:a,MG_PORT:u,MG_NAME:d,MG_USERNAME:c,MG_PASSWORD:l,MONGODB_URI:f}=s.default;i.default.set("strictQuery",!0);const p=f||`mongodb+srv://${c}:${l}@${a}/${d}?retryWrites=true&w=majority`;console.log(p),t.connect=()=>r(void 0,void 0,void 0,(function*(){return i.default.connect(p,{})}))},5343:function(e,t,n){var r=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.env=void 0;const i=n(5142),s=o(n(1017)),a=process.env,{NODE_ENV:u}=a,d=r(a,["NODE_ENV"])||{},c=(0,i.config)("dev"===u?{path:s.default.resolve(process.cwd(),".env.dev")}:void 0).parsed;t.env="production",t.default=Object.assign(Object.assign(Object.assign({},c),{ENV:"production"}),d)},1633:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.JWTResetOpt=t.JWTRefreshOpt=t.JWTTokenOpt=void 0;const o=r(n(5343));t.JWTTokenOpt={expiresIn:"dev"===o.default.ENV?"10s":"3600s"},t.JWTRefreshOpt={expiresIn:"dev"===o.default.ENV?"60s":"86400s"},t.JWTResetOpt={expiresIn:"dev"===o.default.ENV?"180s":"300s"}},6168:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(5184)),u=s(n(5343)),d=a.createTransport({pool:!0,service:u.default.MAIL_SERVICE,auth:{user:u.default.MAIL_USER,pass:u.default.MAIL_PASSWORD}});t.default=d},9818:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.startup=t.setupRedisIndex=t.redis=void 0;const i=n(7773),s=o(n(5343)),a=n(9372);function u(){return r(this,void 0,void 0,(function*(){yield(0,a.setTokenIndex)()}))}t.redis=(0,i.createClient)({password:s.default.RD_PASSWORD,username:s.default.RD_USERNAME,socket:{host:s.default.RD_HOST,port:Number(s.default.RD_PORT)}}),t.setupRedisIndex=u,t.startup=function(){return r(this,void 0,void 0,(function*(){yield t.redis.connect(),yield u()}))}},6464:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(4742),s=n(7797),a=o(n(8849)),u=o(n(4747)),d=o(n(5215)),c=o(n(4947)),l=n(3713),f=o(n(5343));t.default=new class{loginByPassword(e,t){return r(this,void 0,void 0,(function*(){const n=e.body;console.log(n),yield(0,a.default)(t,(()=>r(this,void 0,void 0,(function*(){u.default.validateLoginPassword(n);const e=yield d.default.findUserByPassword(n.username,n.password);if(e){const r=(yield c.default.getVersion(e.uid))||"0",o=(0,s.generateToken)(Object.assign(Object.assign({},e),{version:r,remember:n.remember}),!0);yield c.default.insertRefreshToken(o.refreshToken,e.uid,e.role),function(e,t,n,r){r&&e.cookie("refresh_token",r,(0,i.withAge)(864e5)),e.status(200).cookie("token",n,(0,i.withAge)(t?36e5:void 0)).json({message:"success",data:{accessToken:n,refreshToken:r}}).send()}(t,n.remember,o.accessToken,o.refreshToken)}else t.status(401).json({message:"TÃ i khoáº£n hoáº·c máº­t kháº©u khÃ´ng chÃ­nh xÃ¡c",name:"password"})}))))}))}logout(e,t){return r(this,void 0,void 0,(function*(){const e=t.locals.user;yield(0,a.default)(t,(()=>r(this,void 0,void 0,(function*(){c.default.deleteRefreshToken(e.uid),c.default.updateVersion(e.uid),t.cookie("token",null,(0,i.withAge)(0)),t.cookie("refresh_token",null,(0,i.withAge)(0)),t.sendStatus(200)}))))}))}requestReset(e,t){return r(this,void 0,void 0,(function*(){const n=e.body;console.log(n),yield(0,a.default)(t,(()=>r(this,void 0,void 0,(function*(){u.default.validateRequestReset(n);const e=yield d.default.findUserByInfo(n);if(e){const{username:n,uid:r}=e,o=(0,s.generateResetToken)({username:n,uid:r,role:"admin",version:"0",remember:!1});yield(0,l.sendForgetPasswordMail)(e,o),t.status(200).json({message:"Email Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng tá»›i "+e.email})}else t.status(400).json({message:"KhÃ´ng tá»“n táº¡i email",name:"email"})}))))}))}verifyReset(e,t){return r(this,void 0,void 0,(function*(){const n=t.locals.user.username,r=1e3*t.locals.user.exp,o=Math.floor((r-(new Date).getTime())/1e3);t.cookie("token",e.query.token,(0,i.withAge)(18e4)).redirect(f.default.FRONTEND+"/resetpassword?ttl="+o+"&user="+n)}))}resetPassword(e,t){return r(this,void 0,void 0,(function*(){const n=e.body;yield(0,a.default)(t,(()=>r(this,void 0,void 0,(function*(){u.default.validateReset(n);const e=t.locals.user;yield d.default.updatePassword(e.uid,n.password),t.json({message:"Password changed successfully"})}))))}))}}},6305:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(5215)),s=o(n(4947));t.default=new class{getStatus(e,t){t.json({message:"OK"})}getUser(e,t){return r(this,void 0,void 0,(function*(){const n=e.body;console.log(n);const r=yield i.default.findUserByPassword(n.username,n.password);console.log(r),r?t.json({message:"hello",data:r}):t.json({message:"error",data:{}})}))}addToken(e,t){return r(this,void 0,void 0,(function*(){yield s.default.insertRefreshToken("sdcasdcasdcasdc","21020365","admin"),t.json({message:"OK"})}))}}},3607:function(e,t,n){e=n.nmd(e);var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=a(n(6860)),d=i(n(3582)),c=a(n(9470)),l=a(n(9710)),f=a(n(8479)),p=i(n(5343)),h=i(n(2009)),y=i(n(9818)),v=a(n(6950)),_=n(7520),m=(0,u.default)(),g=p.default.PORT;m.use((0,c.default)("dev"===p.env?"dev":"tiny")),m.use(u.default.json()),m.use(u.default.urlencoded({extended:!0})),m.use((0,l.default)()),m.use(d.default({origin:p.default.FRONTEND,credentials:!0,methods:["GET","PUT","POST","DELETE"],optionsSuccessStatus:200,allowedHeaders:["Content-Type, Authorization"]})),(0,f.default)(m),m.use("/graphql/",(0,_.graphqlHTTP)({schema:v.default,graphiql:!0})),n.c[n.s]===e&&m.listen(g,(()=>s(void 0,void 0,void 0,(function*(){yield y.startup(),console.log("ðŸ“• [database]: Connected to redis"),yield h.connect(),console.log("ðŸ“’ [database]: Connected to mongo"),console.log(`âœ… [server]: Server is running at http://localhost:${g}`)})))),t.default=m},322:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkJWT=void 0;const u=i(n(9344)),d=a(n(5343)),c=n(5326),l=a(n(4947));t.checkJWT=function(e,t,n){return s(this,void 0,void 0,(function*(){const r=this&&"query"===this.tokenOn?e.query.token:e.cookies.token;if(!r)return t.sendStatus(401);try{const e=u.verify(r,d.default.JWT_KEY),o=yield l.default.getVersion(e.uid);if(o&&o!==e.version)return t.sendStatus(401);t.locals.user=e,n()}catch(r){if(!(r instanceof u.TokenExpiredError))return console.log(r),t.sendStatus(401);(0,c.checkRWT)(e,t,n)}}))}},5326:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkRWT=void 0;const u=i(n(9344)),d=a(n(5343)),c=n(7797),l=a(n(4947)),f=n(4742),p=a(n(8849));t.checkRWT=function(e,t,n){return s(this,void 0,void 0,(function*(){const r=e.cookies.refresh_token;(0,p.default)(t,(()=>s(this,void 0,void 0,(function*(){if(!r||!(yield l.default.getRefreshToken(r)))return t.sendStatus(401);try{const e=u.verify(r,d.default.JWT_REFRESH_KEY);e.role=yield l.default.getRole(e.uid),e.version=yield l.default.getVersion(e.uid);const o=(0,c.generateToken)(e,!0);yield l.default.insertRefreshToken(o.refreshToken,e.uid,e.role),t.cookie("refresh_token",o.refreshToken,(0,f.withAge)(864e5)).cookie("token",o.accessToken,(0,f.withAge)(e.remember?36e5:void 0)).locals.user=e,n()}catch(e){console.log(e),t.sendStatus(401)}}))))}))}},6990:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkReset=void 0;const a=i(n(9344)),u=s(n(5343));t.checkReset=function(e,t,n){const r=e.query.token||e.cookies.token;if(!r)return t.sendStatus(401);try{const e=a.verify(r,u.default.JWT_RESET_KEY);t.locals.user=e,n()}catch(e){return console.log(e),t.sendStatus(401)}}},5215:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(8432)),u=n(5102);t.default=new class{findUserByPassword(e,t){return s(this,void 0,void 0,(function*(){const n=yield u.UserBaseModel.findOne({username:e},{uid:1,role:1,username:1,password:1}).exec();if(!n)return;const{uid:r,username:o,password:i,role:s}=n;return t?(yield a.compare(t,i))&&{uid:r,username:o,role:s}:void 0}))}findUserByInfo(e){return s(this,void 0,void 0,(function*(){const t=yield u.UserBaseModel.findOne({$or:[{username:e.username},{email:e.email},{phone:e.phone},{uid:e.uid}]},{email:!0,username:!0,phone:!0,uid:!0}).exec();if(!t)return;const{username:n,phone:r,uid:o,email:i}=t;return{username:n,phone:r,uid:o,email:i}}))}updatePassword(e,t){return s(this,void 0,void 0,(function*(){u.UserBaseModel.updateOne({uid:e},{password:yield a.hash(t,10)}).exec()}))}}},2523:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(7181);t.default=new class{getParcel(e){return r(this,void 0,void 0,(function*(){return Array.isArray(e)?yield o.ParcelBaseModel.find({pid:{$in:e}}).exec():yield o.ParcelBaseModel.find({pid:e}).exec()}))}}},9829:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(3915);t.default=new class{createPostOffice(e){return r(this,void 0,void 0,(function*(){const t=new o.PostOfficeBaseModel(e);yield t.save()}))}getPostOffices(e,t={}){return r(this,void 0,void 0,(function*(){return yield o.PostOfficeBaseModel.find(Object.assign(Object.assign({},t),{post_office_type:e})).exec()}))}}},4841:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AddressSchema=t.AddressLevelSchema=void 0;const r=n(1185);t.AddressLevelSchema=new r.Schema({id:{type:String,required:!0},name:{type:String,required:!0}}),t.AddressSchema=new r.Schema({country:{type:t.AddressLevelSchema,required:!0},province:{type:t.AddressLevelSchema,required:!0},district:{type:t.AddressLevelSchema,required:!0},commune:{type:t.AddressLevelSchema,required:!0},detail:{type:String},lat:{type:Number},long:{type:Number}})},6248:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CustomerSchema=void 0;const r=n(1185);t.CustomerSchema=new r.Schema({name:{type:String,required:!0},phone:{type:String,required:!0}})},4657:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GoodsSchema=t.EGoodsCategory=void 0;const r=n(1185);var o;!function(e){e.ELECTRONICE_DEVICE="Electronic Devices"}(o||(t.EGoodsCategory=o={})),t.GoodsSchema=new r.Schema({name:{type:String},category:{type:String},quantity:{type:Number},value:{type:Number},weight:{type:Number},attached:{type:String}})},7181:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ParcelBaseModel=t.EParcelStatus=void 0;const r=n(1185),o=n(4841),i=n(6248),s=n(4657);var a;!function(e){e.DELIVERING="delivering",e.DELIVERED="delivered",e.FAILED="failed"}(a||(t.EParcelStatus=a={}));const u=new r.Schema({pid:{type:String,required:!0,unique:!0,index:!0},sending_add:{type:o.AddressSchema,required:!0},receiving_add:{type:o.AddressSchema,required:!0},receiver:{type:i.CustomerSchema,required:!0},sender:{type:i.CustomerSchema,required:!0},status:{type:String,required:!0},goods:{type:s.GoodsSchema,required:!0}});t.ParcelBaseModel=(0,r.model)("Parcel",u)},3915:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PostOfficeBaseModel=void 0;const r=n(1185),o=new r.Schema({poid:{type:String,required:!0,unique:!0,index:!0},name:{type:String,required:!0},address:{type:Object,required:!0},managerId:{type:String,required:!0},hotline:{type:String},fax:{type:String},email:{type:String},post_office_type:{type:String,required:!0},post_office_id:{type:String}});t.PostOfficeBaseModel=(0,r.model)("post_office",o)},9372:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setTokenIndex=t.schema=void 0;const o=n(9818),i=n(7773);t.schema={"$.token":{type:i.SchemaFieldTypes.TEXT,AS:"token"},"$.uid":{type:i.SchemaFieldTypes.TEXT,AS:"uid"}},t.setTokenIndex=function(){return r(this,void 0,void 0,(function*(){try{yield o.redis.ft.create("idx:token",t.schema,{ON:"JSON",PREFIX:"token_"})}catch(e){"Index already exists"===e.message?console.log("Index idx:token exists already, skipped creation."):console.error(e)}}))}},5102:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UserBaseModel=void 0;const r=n(1185),o=new r.Schema({uid:{type:String,required:!0,unique:!0,index:!0},username:{type:String,required:!0,unique:!0,index:!0},password:{type:String,required:!0},role:{type:String,required:!0},version:{type:Number,required:!0},email:{type:String,unique:!0,index:!0},phone:{type:String,unique:!0,index:!0}});t.UserBaseModel=(0,r.model)("User",o)},4947:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(9818),i=n(4816);t.default=new class{insertRefreshToken(e,t,n){return r(this,void 0,void 0,(function*(){if(yield o.redis.set((0,i.getKey)(t,i.NameType.USER_VERSION),0,{NX:!0}),"OK"!==(yield o.redis.json.set((0,i.getKey)(e,i.NameType.TOKEN),"$",{uid:t,token:e}))||"OK"!==(yield o.redis.set((0,i.getKey)(t,i.NameType.USER_ROLE),n)))throw new Error("Unable to add refresh token")}))}getRefreshToken(e){return r(this,void 0,void 0,(function*(){return yield o.redis.json.get((0,i.getKey)(e,i.NameType.TOKEN))}))}deleteRefreshToken(e){return r(this,void 0,void 0,(function*(){const t=yield o.redis.ft.search("idx:token",`@uid:"${e}"`);t&&(yield Promise.all(t.documents.map((e=>o.redis.json.del(e.id)))))}))}updateVersion(e){return r(this,void 0,void 0,(function*(){if(!o.redis.incr((0,i.getKey)(e,i.NameType.USER_VERSION)))throw new Error("Unable to update version")}))}getVersion(e){return r(this,void 0,void 0,(function*(){return yield o.redis.get((0,i.getKey)(e,i.NameType.USER_VERSION))}))}getRole(e){return r(this,void 0,void 0,(function*(){return yield o.redis.get((0,i.getKey)(e,i.NameType.USER_ROLE))}))}}},8479:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(8961));t.default=function(e){e.use("/v1",o.default)}},9413:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(6860)),i=r(n(6464)),s=n(322),a=n(6990),u=o.default.Router();u.post("/login",i.default.loginByPassword),u.post("/logout",[s.checkJWT],i.default.logout),u.post("/reset",i.default.requestReset),u.get("/reset",[a.checkReset],i.default.verifyReset),u.put("/reset",[a.checkReset],i.default.resetPassword),t.default=u},8961:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(6860),i=r(n(9690)),s=r(n(9413)),a=(0,o.Router)();a.use("/",i.default),a.use("/auth",s.default),t.default=a},9690:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(6860)),i=r(n(6305)),s=o.default.Router();s.get("/",i.default.getStatus),s.post("/user",i.default.getUser),s.post("/token",i.default.addToken),t.default=s},6950:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(7343),o=n(7244),i=n(1504),s=new r.GraphQLObjectType({name:"Query",description:"Root Query",fields:()=>({gatherPostOffices:o.gatherPostOfficesQuery,transPostOffices:o.transPostOfficesQuery,parcels:i.parcelsQuery})}),a=new r.GraphQLSchema({query:s});t.default=a},1504:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.parcelsQuery=void 0;const i=o(n(2523)),s=n(7343),a=n(6329);t.parcelsQuery={type:(0,s.GraphQLList)(a.ParcelGraph),description:"List all parcels statifying filter.",args:{pid:{type:s.GraphQLString},pids:{type:(0,s.GraphQLList)(s.GraphQLString)}},resolve:(e,t)=>r(void 0,void 0,void 0,(function*(){return t.pid?yield i.default.getParcel(t.pid):t.pids?yield i.default.getParcel(t.pids):[]}))}},7244:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.transPostOfficesQuery=t.gatherPostOfficesQuery=void 0;const i=n(7343),s=n(7590),a=o(n(9829)),u=n(5967);t.gatherPostOfficesQuery={type:(0,i.GraphQLList)(s.PostOfficeGraph),description:"List of all gathering post offices statifying filter.",args:{poid:{type:i.GraphQLString}},resolve:(e,t)=>r(void 0,void 0,void 0,(function*(){return yield a.default.getPostOffices(u.PostOfficeType.Gather,t)}))},t.transPostOfficesQuery={type:(0,i.GraphQLList)(s.PostOfficeGraph),description:"List of all transaction post offices statifying filter.",args:{poid:{type:i.GraphQLString}},resolve:(e,t)=>r(void 0,void 0,void 0,(function*(){return yield a.default.getPostOffices(u.PostOfficeType.Transaction,t)}))}},6536:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AddressGraph=t.AddressLevelGraph=void 0;const r=n(7343);t.AddressLevelGraph=new r.GraphQLObjectType({name:"AddressLevelGraph",description:"Address Level Graph",fields:{id:{type:r.GraphQLString},name:{type:r.GraphQLString}}}),t.AddressGraph=new r.GraphQLObjectType({name:"AddressGraph",description:"Address Graph",fields:{country:{type:t.AddressLevelGraph},province:{type:t.AddressLevelGraph},district:{type:t.AddressLevelGraph},commune:{type:t.AddressLevelGraph},detail:{type:r.GraphQLString},lat:{type:r.GraphQLFloat},long:{type:r.GraphQLFloat}}})},7669:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CustomerGraph=void 0;const r=n(7343);t.CustomerGraph=new r.GraphQLObjectType({name:"CustomerGraph",description:"Customer Graph",fields:{name:{type:r.GraphQLString},phone:{type:r.GraphQLString}}})},1697:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GoodsGraph=void 0;const r=n(4657),o=n(7343),i=new o.GraphQLEnumType({name:"GoodsCategoryEnum",description:"Goods Category Enum",values:{ELECTRONICE_DEVICE:{value:r.EGoodsCategory.ELECTRONICE_DEVICE}}});t.GoodsGraph=new o.GraphQLObjectType({name:"GoodsGraph",description:"Goods Graph",fields:{name:{type:o.GraphQLString},category:{type:i},quantity:{type:o.GraphQLInt},value:{type:o.GraphQLInt},weight:{type:o.GraphQLInt},attached:{type:o.GraphQLString}}})},6329:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ParcelGraph=void 0;const r=n(7343),o=n(6536),i=n(7669),s=n(1697),a=n(7181),u=new r.GraphQLEnumType({name:"ParcelStatusEnum",description:"Parcel Status Enum",values:{DELIVERING:{value:a.EParcelStatus.DELIVERING},DELIVERED:{value:a.EParcelStatus.DELIVERED},FAILED:{value:a.EParcelStatus.FAILED}}});t.ParcelGraph=new r.GraphQLObjectType({name:"ParcelGraph",description:"Parcel Graph",fields:{pid:{type:r.GraphQLString},sending_add:{type:o.AddressGraph},receiving_add:{type:o.AddressGraph},sender:{type:i.CustomerGraph},receiver:{type:i.CustomerGraph},status:{type:u},goods:{type:s.GoodsGraph}}})},7590:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PostOfficeTypeEnum=t.PostOfficeGraph=void 0;const o=n(7343),i=n(5967),s=n(6536),a=r(n(9829)),u=new o.GraphQLEnumType({name:"PostOfficeTypeEnum",description:"Post Office Type Enum",values:{TRANSACTION:{value:i.PostOfficeType.Transaction},GATHERING:{value:i.PostOfficeType.Gather}}});t.PostOfficeTypeEnum=u;const d=new o.GraphQLObjectType({name:"PostOfficeGraph",description:"Post Office Graph",fields:()=>({poid:{type:o.GraphQLString},name:{type:o.GraphQLString},address:{type:s.AddressGraph},manager_id:{type:o.GraphQLString},hotline:{type:o.GraphQLString},fax:{type:o.GraphQLString},email:{type:o.GraphQLString},post_office_type:{type:u},post_office_id:{type:o.GraphQLString},tranPostOffice:{type:new o.GraphQLList(d),resolve:(e,t)=>a.default.getPostOffices(i.PostOfficeType.Transaction,{post_office_id:e.poid})}})});t.PostOfficeGraph=d},5417:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.InputError=void 0;class n extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,n.prototype),this.field=t}}t.InputError=n},5967:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.PostOfficeType=void 0,function(e){e.Gather="gathering",e.Transaction="transaction"}(n||(t.PostOfficeType=n={}))},7797:function(e,t,n){var r=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.generate_password=t.generateResetToken=t.generateToken=t.generate_uid=void 0;const i=n(9344),s=o(n(5343)),a=n(1633);function u(e,t){return Math.floor(Math.random()*(t-e))+e}t.generate_uid=function(e=8){return e=e>0?e:8,[...new Array(e)].map((()=>u(0,9).toString())).join("")},t.generateToken=function(e,t){const n=e,{iat:o,exp:u}=n,d=r(n,["iat","exp"]);return{accessToken:(0,i.sign)(d,s.default.JWT_KEY,a.JWTTokenOpt),refreshToken:t&&(0,i.sign)(d,s.default.JWT_REFRESH_KEY,a.JWTRefreshOpt)}},t.generateResetToken=function(e){const t=e,{iat:n,exp:o}=t,u=r(t,["iat","exp"]);return(0,i.sign)(u,s.default.JWT_RESET_KEY,a.JWTResetOpt)},t.generate_password=function(e=8){e=e>0?e:8;return[...new Array(e)].map((()=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"[u(0,61)])).join("")}},8849:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(5417);t.default=function(e,t){return r(this,void 0,void 0,(function*(){try{yield t()}catch(t){console.log(t),t instanceof o.InputError?e.status(400).json({message:t.message,name:t.field}):e.sendStatus(500)}}))}},4816:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.getKey=t.NameType=void 0,function(e){e[e.USER_VERSION=0]="USER_VERSION",e[e.USER_ROLE=1]="USER_ROLE",e[e.TOKEN=2]="TOKEN"}(n||(t.NameType=n={})),t.getKey=function(e,t){return t===n.USER_VERSION&&e+"_v"||t===n.USER_ROLE&&e+"_r"||t===n.TOKEN&&"token_"+e||e}},3713:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.startup=t.sendForgetPasswordMail=t.sendMail=t.renderTemplate=void 0;const u=a(n(6168)),d=a(n(5343)),c=i(n(2097)),l=i(n(7147)),f=i(n(1017));function p(e,t,n){return s(this,void 0,void 0,(function*(){yield u.default.sendMail({from:`"${d.default.APP_NAME}" <${d.default.MAIL_USER}>`,to:e,subject:t,html:n})}))}t.renderTemplate=(e,t)=>{const n=f.join(f.resolve(),e),r=l.readFileSync(n,"utf-8").toString();return c.compile(r)(t)},t.sendMail=p,t.sendForgetPasswordMail=function(e,n){return s(this,void 0,void 0,(function*(){const r=(0,t.renderTemplate)("/src/templates/forgot-password-email.html",{url:`${d.default.BACKEND}/auth/reset?token=${n}`,name:e.username});return yield p(e.email,"KhÃ´i phá»¥c máº­t kháº©u trÃªn "+d.default.APP_NAME,r)}))},t.startup=function(){return s(this,void 0,void 0,(function*(){return yield p("fakenoname02@gmail.com","Server started","Server started now")}))}},4747:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(5417);t.default=new class{validateUsername(e){if(!e||e.length<3||e.length>50)throw new r.InputError("Username cÃ³ Ä‘á»™ dÃ i tá»« 3 Ä‘áº¿n 50 kÃ½ tá»±","username");return!0}validatePassword(e){if(!e||e.length<8||e.length>50)throw new r.InputError("Máº­t kháº©u cÃ³ Ä‘á»™ dÃ i tá»« 8 Ä‘áº¿n 50 kÃ½ tá»±","password");return!0}validateEmail(e){if(!e||!/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(e))throw new r.InputError("Email khÃ´ng há»£p lá»‡","email");return!0}validateRePassword(e,t){if(t!=e)throw new r.InputError("Máº­t kháº©u nháº­p láº¡i cáº§n giá»‘ng máº­t kháº©u","re_password")}validateLoginPassword(e){this.validateUsername(e.username),this.validatePassword(e.password)}validateRequestReset(e){e.username&&this.validateUsername(e.username)||this.validateEmail(e.email)}validateReset(e){this.validatePassword(e.password),this.validateRePassword(e.password,e.re_password)}}},8432:e=>{e.exports=require("bcryptjs")},9710:e=>{e.exports=require("cookie-parser")},3582:e=>{e.exports=require("cors")},5142:e=>{e.exports=require("dotenv")},6860:e=>{e.exports=require("express")},7520:e=>{e.exports=require("express-graphql")},7343:e=>{e.exports=require("graphql")},2097:e=>{e.exports=require("handlebars")},9344:e=>{e.exports=require("jsonwebtoken")},1185:e=>{e.exports=require("mongoose")},9470:e=>{e.exports=require("morgan")},5184:e=>{e.exports=require("nodemailer")},7773:e=>{e.exports=require("redis")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={id:r,loaded:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}n.c=t,n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),n(n.s=3607)})();